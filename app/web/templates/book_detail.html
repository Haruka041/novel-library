{% extends "base.html" %}

{% block title %}{{ book_title|default('ä¹¦ç±è¯¦æƒ…') }} - å°è¯´ä¹¦åº“{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- è¿”å›å¯¼èˆª -->
    <div class="mb-4">
        <button onclick="history.back()" class="text-blue-500 hover:text-blue-700 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            è¿”å›
        </button>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading" class="text-center py-20">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        <p class="text-gray-500 mt-4">åŠ è½½ä¸­...</p>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 text-center">
        <p class="text-red-600 text-lg mb-2">âš ï¸ åŠ è½½å¤±è´¥</p>
        <p id="error-message" class="text-red-500"></p>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div id="content" class="hidden">
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <!-- ä¹¦ç±åŸºæœ¬ä¿¡æ¯ -->
            <div class="md:flex">
                <!-- å°é¢åŒºåŸŸ -->
                <div class="md:flex-shrink-0 bg-gray-100 flex items-center justify-center p-6">
                    <img id="book-cover" src="" alt="ä¹¦ç±å°é¢" 
                         class="w-full md:w-64 rounded-lg shadow-lg"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'450\' viewBox=\'0 0 300 450\'%3E%3Crect fill=\'%23e5e7eb\' width=\'300\' height=\'450\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'sans-serif\' font-size=\'24\' fill=\'%239ca3af\'%3Eæ— å°é¢%3C/text%3E%3C/svg%3E'">
                </div>

                <!-- ä¿¡æ¯åŒºåŸŸ -->
                <div class="p-6 flex-1">
                    <!-- æ ‡é¢˜å’Œä½œè€… -->
                    <div class="mb-4">
                        <h1 id="book-title" class="text-3xl font-bold text-gray-900 mb-2"></h1>
                        <p class="text-xl text-gray-600">
                            <span class="font-semibold">ä½œè€…ï¼š</span>
                            <span id="book-author"></span>
                        </p>
                    </div>

                    <!-- å…ƒæ•°æ®ä¿¡æ¯ -->
                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div>
                            <span class="text-gray-500">æ ¼å¼ï¼š</span>
                            <span id="book-format" class="font-semibold uppercase"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">å¤§å°ï¼š</span>
                            <span id="book-size" class="font-semibold"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">æ·»åŠ æ—¶é—´ï¼š</span>
                            <span id="book-added" class="font-semibold"></span>
                        </div>
                        <div id="publisher-container" class="hidden">
                            <span class="text-gray-500">å‡ºç‰ˆç¤¾ï¼š</span>
                            <span id="book-publisher" class="font-semibold"></span>
                        </div>
                    </div>

                    <!-- å†…å®¹åˆ†çº§å¾½ç«  -->
                    <div class="mb-4">
                        <span id="age-rating-badge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"></span>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex flex-wrap gap-3 mb-4">
                        <a id="read-button" href="#" 
                           class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                            ğŸ“– å¼€å§‹é˜…è¯»
                        </a>
                        <a id="download-button" href="#" 
                           class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2">
                            â¬‡ï¸ ä¸‹è½½
                        </a>
                        <button id="favorite-button" 
                                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center gap-2">
                            <span id="favorite-icon">ğŸ¤</span>
                            <span id="favorite-text">æ”¶è—</span>
                        </button>
                    </div>

                    <!-- é˜…è¯»è¿›åº¦ -->
                    <div id="progress-container" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">é˜…è¯»è¿›åº¦</span>
                            <span id="progress-percent" class="text-sm font-bold text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="last-read" class="text-xs text-gray-500 mt-2"></p>
                    </div>
                </div>
            </div>

            <!-- è¯¦ç»†ä¿¡æ¯åŒºåŸŸ -->
            <div class="border-t border-gray-200 p-6 space-y-6">
                <!-- ç®€ä»‹ -->
                <div id="description-container" class="hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-3">ğŸ“ ç®€ä»‹</h2>
                    <p id="book-description" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></p>
                </div>

                <!-- å†…å®¹è­¦å‘Š -->
                <div id="warning-container" class="hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-3">âš ï¸ å†…å®¹è­¦å‘Š</h2>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <p id="content-warning" class="text-yellow-700"></p>
                    </div>
                </div>

                <!-- ç³»ç»Ÿæ ‡ç­¾ -->
                <div>
                    <h2 class="text-xl font-bold text-gray-900 mb-3">ğŸ·ï¸ æ ‡ç­¾</h2>
                    <div id="system-tags" class="flex flex-wrap gap-2">
                        <span class="text-gray-500 text-sm">åŠ è½½ä¸­...</span>
                    </div>
                </div>

                <!-- æˆ‘çš„æ ‡ç­¾ -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-xl font-bold text-gray-900">ğŸ“š æˆ‘çš„æ ‡ç­¾</h2>
                        <button id="add-tag-button" 
                                class="px-4 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">
                            + æ·»åŠ æ ‡ç­¾
                        </button>
                    </div>
                    <div id="personal-tags" class="flex flex-wrap gap-2">
                        <span class="text-gray-500 text-sm">æš‚æ— ä¸ªäººæ ‡ç­¾</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ æ ‡ç­¾å¯¹è¯æ¡† -->
<div id="tag-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">æ·»åŠ ä¸ªäººæ ‡ç­¾</h3>
            <input type="text" id="tag-input" 
                   placeholder="è¾“å…¥æ ‡ç­¾åç§°ï¼ˆ1-50å­—ç¬¦ï¼‰"
                   maxlength="50"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div class="flex gap-3">
                <button id="tag-submit" 
                        class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    ç¡®å®š
                </button>
                <button id="tag-cancel" 
                        class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const bookId = parseInt('{{ book_id }}');
let bookData = null;
let isFavorite = false;

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', async () => {
    await loadBookData();
});

// åŠ è½½ä¹¦ç±æ•°æ®
async function loadBookData() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }

    try {
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
        const [bookRes, tagsRes, personalTagsRes, favoriteRes, progressRes] = await Promise.all([
            fetch(`/api/books/${bookId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`/api/books/${bookId}/tags`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`/api/user/my-tags/books/${bookId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`/api/user/favorites/${bookId}/check`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`/api/progress/${bookId}`, { headers: { 'Authorization': `Bearer ${token}` } })
        ]);

        if (bookRes.status === 403) {
            showError('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤ä¹¦ç±');
            return;
        }

        if (!bookRes.ok) {
            showError('æ— æ³•åŠ è½½ä¹¦ç±ä¿¡æ¯');
            return;
        }

        bookData = await bookRes.json();
        const tags = tagsRes.ok ? await tagsRes.json() : [];
        const personalTags = personalTagsRes.ok ? await personalTagsRes.json() : { tags: [] };
        const favorite = favoriteRes.ok ? await favoriteRes.json() : { is_favorite: false };
        const progress = progressRes.ok ? await progressRes.json() : { progress: 0 };

        // æ¸²æŸ“é¡µé¢
        renderBookInfo(bookData);
        renderTags(tags);
        renderPersonalTags(personalTags.tags);
        renderFavoriteStatus(favorite.is_favorite);
        renderProgress(progress);

        // æ˜¾ç¤ºå†…å®¹
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

    } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// æ¸²æŸ“ä¹¦ç±ä¿¡æ¯
function renderBookInfo(book) {
    document.getElementById('book-title').textContent = book.title;
    document.getElementById('book-author').textContent = book.author_name || 'æœªçŸ¥ä½œè€…';
    document.getElementById('book-format').textContent = book.file_format;
    document.getElementById('book-size').textContent = formatFileSize(book.file_size);
    document.getElementById('book-added').textContent = new Date(book.added_at).toLocaleDateString('zh-CN');
    
    // å‡ºç‰ˆç¤¾ï¼ˆå¦‚æœæœ‰ï¼‰
    if (book.publisher) {
        document.getElementById('book-publisher').textContent = book.publisher;
        document.getElementById('publisher-container').classList.remove('hidden');
    }

    // å°é¢
    document.getElementById('book-cover').src = `/books/${bookId}/cover?size=thumbnail`;

    // ç®€ä»‹
    if (book.description) {
        document.getElementById('book-description').textContent = book.description;
        document.getElementById('description-container').classList.remove('hidden');
    }

    // å†…å®¹è­¦å‘Š
    if (book.content_warning) {
        document.getElementById('content-warning').textContent = book.content_warning;
        document.getElementById('warning-container').classList.remove('hidden');
    }

    // å†…å®¹åˆ†çº§å¾½ç« 
    const badge = document.getElementById('age-rating-badge');
    const ratingConfig = {
        'general': { text: 'å…¨å¹´é¾„', color: 'bg-green-100 text-green-800' },
        'teen': { text: 'é’å°‘å¹´', color: 'bg-blue-100 text-blue-800' },
        'adult': { text: 'æˆäºº ğŸ”', color: 'bg-red-100 text-red-800' }
    };
    const rating = ratingConfig[book.age_rating] || ratingConfig['general'];
    badge.textContent = rating.text;
    badge.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${rating.color}`;

    // æŒ‰é’®é“¾æ¥
    document.getElementById('read-button').href = `/reader/${bookId}`;
    document.getElementById('download-button').href = `/books/${bookId}/download`;
}

// æ¸²æŸ“ç³»ç»Ÿæ ‡ç­¾
function renderTags(tags) {
    const container = document.getElementById('system-tags');
    if (tags.length === 0) {
        container.innerHTML = '<span class="text-gray-500 text-sm">æš‚æ— æ ‡ç­¾</span>';
        return;
    }

    const tagColors = {
        'genre': 'bg-purple-100 text-purple-800',
        'age_rating': 'bg-red-100 text-red-800',
        'custom': 'bg-gray-100 text-gray-800'
    };

    container.innerHTML = tags.map(tag => {
        const color = tagColors[tag.type] || tagColors['custom'];
        return `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${color}">${tag.name}</span>`;
    }).join('');
}

// æ¸²æŸ“ä¸ªäººæ ‡ç­¾
function renderPersonalTags(tags) {
    const container = document.getElementById('personal-tags');
    if (tags.length === 0) {
        container.innerHTML = '<span class="text-gray-500 text-sm">æš‚æ— ä¸ªäººæ ‡ç­¾</span>';
        return;
    }

    container.innerHTML = tags.map(tag => `
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 gap-2">
            ${tag.tag_name}
            <button onclick="deletePersonalTag(${tag.id})" class="hover:text-yellow-900">âœ•</button>
        </span>
    `).join('');
}

// æ¸²æŸ“æ”¶è—çŠ¶æ€
function renderFavoriteStatus(favorite) {
    isFavorite = favorite;
    const button = document.getElementById('favorite-button');
    const icon = document.getElementById('favorite-icon');
    const text = document.getElementById('favorite-text');

    if (isFavorite) {
        button.className = 'px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 flex items-center gap-2';
        icon.textContent = 'â¤ï¸';
        text.textContent = 'å·²æ”¶è—';
    } else {
        button.className = 'px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center gap-2';
        icon.textContent = 'ğŸ¤';
        text.textContent = 'æ”¶è—';
    }
}

// æ¸²æŸ“é˜…è¯»è¿›åº¦
function renderProgress(progress) {
    if (progress.progress > 0) {
        const container = document.getElementById('progress-container');
        const percent = Math.round(progress.progress * 100);
        
        document.getElementById('progress-percent').textContent = `${percent}%`;
        document.getElementById('progress-bar').style.width = `${percent}%`;
        
        if (progress.last_read_at) {
            const lastRead = new Date(progress.last_read_at);
            document.getElementById('last-read').textContent = 
                `æœ€åé˜…è¯»ï¼š${lastRead.toLocaleString('zh-CN')}`;
        }
        
        container.classList.remove('hidden');
    }
}

// åˆ‡æ¢æ”¶è—çŠ¶æ€
document.getElementById('favorite-button').addEventListener('click', async () => {
    const token = localStorage.getItem('access_token');
    
    try {
        const method = isFavorite ? 'DELETE' : 'POST';
        const response = await fetch(`/api/user/favorites/${bookId}`, {
            method: method,
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            isFavorite = !isFavorite;
            renderFavoriteStatus(isFavorite);
        } else {
            const data = await response.json();
            alert(data.detail || 'æ“ä½œå¤±è´¥');
        }
    } catch (error) {
        console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
});

// æ·»åŠ æ ‡ç­¾å¯¹è¯æ¡†
document.getElementById('add-tag-button').addEventListener('click', () => {
    document.getElementById('tag-modal').classList.remove('hidden');
    document.getElementById('tag-input').value = '';
    document.getElementById('tag-input').focus();
});

document.getElementById('tag-cancel').addEventListener('click', () => {
    document.getElementById('tag-modal').classList.add('hidden');
});

document.getElementById('tag-submit').addEventListener('click', async () => {
    const tagName = document.getElementById('tag-input').value.trim();
    
    if (!tagName || tagName.length > 50) {
        alert('æ ‡ç­¾åç§°æ— æ•ˆï¼ˆé•¿åº¦åº”åœ¨1-50å­—ç¬¦ä¹‹é—´ï¼‰');
        return;
    }

    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/user/my-tags/${bookId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ tag_name: tagName })
        });

        if (response.ok) {
            document.getElementById('tag-modal').classList.add('hidden');
            // é‡æ–°åŠ è½½ä¸ªäººæ ‡ç­¾
            const tagsRes = await fetch(`/api/user/my-tags/books/${bookId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const personalTags = await tagsRes.json();
            renderPersonalTags(personalTags.tags);
        } else {
            const data = await response.json();
            alert(data.detail || 'æ·»åŠ å¤±è´¥');
        }
    } catch (error) {
        console.error('æ·»åŠ æ ‡ç­¾å¤±è´¥:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
});

// å›è½¦æäº¤æ ‡ç­¾
document.getElementById('tag-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('tag-submit').click();
    }
});

// åˆ é™¤ä¸ªäººæ ‡ç­¾
async function deletePersonalTag(tagId) {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ ‡ç­¾å—ï¼Ÿ')) return;

    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/user/my-tags/${tagId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            // é‡æ–°åŠ è½½ä¸ªäººæ ‡ç­¾
            const tagsRes = await fetch(`/api/user/my-tags/books/${bookId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const personalTags = await tagsRes.json();
            renderPersonalTags(personalTags.tags);
        } else {
            alert('åˆ é™¤å¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ é™¤æ ‡ç­¾å¤±è´¥:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('error-message').textContent = message;
    document.getElementById('error').classList.remove('hidden');
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
}
</script>
{% endblock %}
