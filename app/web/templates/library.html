{% extends "base.html" %}

{% block title %}ä¹¦åº“ - å°è¯´ä¹¦åº“{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-4">ä¹¦åº“æµè§ˆ</h2>
        
        <div class="mb-6 flex gap-3">
            <input type="text" id="search-input" placeholder="æœç´¢ä¹¦åæˆ–ä½œè€…... (å›è½¦è·³è½¬åˆ°é«˜çº§æœç´¢)"
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <a href="/search" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                ğŸ” é«˜çº§æœç´¢
            </a>
        </div>

        <div id="books-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- ä¹¦ç±åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <div id="loading" class="text-center py-8">
            <p class="text-gray-500">åŠ è½½ä¸­...</p>
        </div>

        <div id="empty" class="text-center py-8 hidden">
            <p class="text-gray-500">æš‚æ— ä¹¦ç±</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let isLoading = false;

// æœç´¢æ¡†å›è½¦è·³è½¬
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const query = searchInput.value.trim();
            if (query) {
                window.location.href = `/search?q=${encodeURIComponent(query)}`;
            } else {
                window.location.href = '/search';
            }
        }
    });
    
    loadBooks();
});

async function loadBooks() {
    if (isLoading) return;
    isLoading = true;

    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }

    try {
        const response = await fetch(`/api/books?page=${currentPage}&limit=20`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const books = await response.json();
            displayBooks(books);
            document.getElementById('loading').classList.add('hidden');
            
            if (books.length === 0 && currentPage === 1) {
                document.getElementById('empty').classList.remove('hidden');
            }
        } else if (response.status === 401) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('åŠ è½½ä¹¦ç±å¤±è´¥:', error);
    } finally {
        isLoading = false;
    }
}

function displayBooks(books) {
    const container = document.getElementById('books-container');
    
    books.forEach(book => {
        const bookCard = document.createElement('div');
        bookCard.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer';
        bookCard.onclick = () => window.location.href = `/book/${book.id}`;
        bookCard.innerHTML = `
            <h3 class="text-lg font-semibold mb-2 text-blue-600 hover:text-blue-800">${book.title}</h3>
            <p class="text-gray-600 text-sm mb-2">ä½œè€…: ${book.author_name || 'æœªçŸ¥'}</p>
            <p class="text-gray-500 text-xs mb-2">æ ¼å¼: ${book.file_format}</p>
            <p class="text-gray-500 text-xs">å¤§å°: ${formatFileSize(book.file_size)}</p>
        `;
        container.appendChild(bookCard);
    });
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
}
</script>
{% endblock %}
