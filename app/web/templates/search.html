{% extends "base.html" %}

{% block title %}é«˜çº§æœç´¢ - å°è¯´ä¹¦åº“{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="max-w-6xl mx-auto">
        <!-- æœç´¢æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ” é«˜çº§æœç´¢</h1>
            <p class="text-gray-600">å¿«é€Ÿæ‰¾åˆ°æ‚¨æƒ³è¦çš„ä¹¦ç±</p>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex gap-3 mb-4">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="æœç´¢ä¹¦åæˆ–ä½œè€…..."
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                    autocomplete="off">
                <button 
                    id="search-btn"
                    class="px-8 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                    æœç´¢
                </button>
            </div>

            <!-- æœç´¢å†å² -->
            <div id="search-history" class="hidden">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-sm text-gray-500">æœ€è¿‘æœç´¢:</span>
                    <div id="history-tags" class="flex gap-2 flex-wrap"></div>
                    <button id="clear-history" class="text-xs text-red-500 hover:text-red-700">æ¸…ç©ºå†å²</button>
                </div>
            </div>
        </div>

        <!-- é«˜çº§ç­›é€‰ -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-800">é«˜çº§ç­›é€‰</h2>
                <button id="toggle-filters" class="text-sm text-blue-500 hover:text-blue-700">
                    <span id="filter-toggle-text">æ”¶èµ·</span>
                    <span id="filter-toggle-icon">â–²</span>
                </button>
            </div>
            
            <div id="filter-panel" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- ä½œè€…ç­›é€‰ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ ä½œè€…</label>
                    <select id="filter-author" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">å…¨éƒ¨ä½œè€…</option>
                    </select>
                </div>

                <!-- æ ¼å¼ç­›é€‰ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“„ æ ¼å¼</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" value="txt" class="format-checkbox mr-2 rounded text-blue-500 focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm">TXT</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" value="epub" class="format-checkbox mr-2 rounded text-blue-500 focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm">EPUB</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" value="mobi" class="format-checkbox mr-2 rounded text-blue-500 focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm">MOBI</span>
                        </label>
                    </div>
                </div>

                <!-- ä¹¦åº“ç­›é€‰ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“š ä¹¦åº“</label>
                    <select id="filter-library" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">å…¨éƒ¨ä¹¦åº“</option>
                    </select>
                </div>
            </div>

            <!-- é‡ç½®æŒ‰é’® -->
            <div class="mt-4 flex justify-end">
                <button id="reset-filters" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50">
                    é‡ç½®ç­›é€‰
                </button>
            </div>

            <!-- æ¿€æ´»çš„ç­›é€‰æ ‡ç­¾ -->
            <div id="active-filters" class="hidden mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-sm text-gray-500">å½“å‰ç­›é€‰:</span>
                    <div id="filter-tags" class="flex gap-2 flex-wrap"></div>
                </div>
            </div>
        </div>

        <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
        <div id="result-stats" class="hidden mb-4 text-gray-600">
            æ‰¾åˆ° <span id="result-count" class="font-semibold text-blue-600">0</span> æœ¬ä¹¦ç±
        </div>

        <!-- ä¹¦ç±åˆ—è¡¨ -->
        <div id="books-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6">
            <!-- ä¹¦ç±å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="text-gray-500 mt-4">æœç´¢ä¸­...</p>
        </div>

        <!-- ç©ºç»“æœæç¤º -->
        <div id="empty" class="hidden text-center py-12">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-gray-500 mt-4 text-lg">æœªæ‰¾åˆ°åŒ¹é…çš„ä¹¦ç±</p>
            <p class="text-gray-400 mt-2">è¯•è¯•è°ƒæ•´æœç´¢å…³é”®è¯æˆ–ç­›é€‰æ¡ä»¶</p>
        </div>

        <!-- åˆå§‹æç¤º -->
        <div id="initial-prompt" class="text-center py-12">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p class="text-gray-500 mt-4 text-lg">è¾“å…¥å…³é”®è¯æˆ–é€‰æ‹©ç­›é€‰æ¡ä»¶å¼€å§‹æœç´¢</p>
        </div>

        <!-- åˆ†é¡µæ§ä»¶ -->
        <div id="pagination" class="hidden mt-8 flex justify-center items-center gap-2">
            <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// å…¨å±€å˜é‡
let currentPage = 1;
let totalPages = 0;
let currentQuery = '';
let currentFilters = {
    author_id: null,
    formats: [],
    library_id: null
};
let searchTimeout = null;
let authorsCache = [];
let librariesCache = [];

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
    await loadAuthors();
    await loadLibraries();
    loadSearchHistory();
    initializeEventListeners();
    parseURLParams();
    
    // å¦‚æœURLæœ‰å‚æ•°ï¼Œè‡ªåŠ¨è§¦å‘æœç´¢
    if (currentQuery || hasActiveFilters()) {
        performSearch();
    }
});

// è§£æURLå‚æ•°
function parseURLParams() {
    const params = new URLSearchParams(window.location.search);
    
    if (params.get('q')) {
        currentQuery = params.get('q');
        document.getElementById('search-input').value = currentQuery;
    }
    
    if (params.get('author_id')) {
        currentFilters.author_id = parseInt(params.get('author_id'));
        document.getElementById('filter-author').value = currentFilters.author_id;
    }
    
    if (params.get('formats')) {
        currentFilters.formats = params.get('formats').split(',');
        document.querySelectorAll('.format-checkbox').forEach(cb => {
            cb.checked = currentFilters.formats.includes(cb.value);
        });
    }
    
    if (params.get('library_id')) {
        currentFilters.library_id = parseInt(params.get('library_id'));
        document.getElementById('filter-library').value = currentFilters.library_id;
    }
    
    if (params.get('page')) {
        currentPage = parseInt(params.get('page'));
    }
    
    updateActiveFilterTags();
}

// æ›´æ–°URLå‚æ•°
function updateURLParams() {
    const params = new URLSearchParams();
    
    if (currentQuery) params.set('q', currentQuery);
    if (currentFilters.author_id) params.set('author_id', currentFilters.author_id);
    if (currentFilters.formats.length > 0) params.set('formats', currentFilters.formats.join(','));
    if (currentFilters.library_id) params.set('library_id', currentFilters.library_id);
    if (currentPage > 1) params.set('page', currentPage);
    
    const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
    window.history.pushState({}, '', newURL);
}

// æ£€æŸ¥æ˜¯å¦æœ‰æ¿€æ´»çš„ç­›é€‰
function hasActiveFilters() {
    return currentFilters.author_id || currentFilters.formats.length > 0 || currentFilters.library_id;
}

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function initializeEventListeners() {
    // æœç´¢æ¡†
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentQuery = e.target.value.trim();
            currentPage = 1;
            performSearch();
        }, 500);
    });
    
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            currentQuery = e.target.value.trim();
            currentPage = 1;
            performSearch();
        }
    });
    
    // æœç´¢æŒ‰é’®
    document.getElementById('search-btn').addEventListener('click', () => {
        clearTimeout(searchTimeout);
        currentQuery = searchInput.value.trim();
        currentPage = 1;
        performSearch();
    });
    
    // ä½œè€…ç­›é€‰
    document.getElementById('filter-author').addEventListener('change', (e) => {
        currentFilters.author_id = e.target.value ? parseInt(e.target.value) : null;
        currentPage = 1;
        updateActiveFilterTags();
        performSearch();
    });
    
    // æ ¼å¼ç­›é€‰
    document.querySelectorAll('.format-checkbox').forEach(cb => {
        cb.addEventListener('change', () => {
            currentFilters.formats = Array.from(document.querySelectorAll('.format-checkbox:checked'))
                .map(c => c.value);
            currentPage = 1;
            updateActiveFilterTags();
            performSearch();
        });
    });
    
    // ä¹¦åº“ç­›é€‰
    document.getElementById('filter-library').addEventListener('change', (e) => {
        currentFilters.library_id = e.target.value ? parseInt(e.target.value) : null;
        currentPage = 1;
        updateActiveFilterTags();
        performSearch();
    });
    
    // é‡ç½®ç­›é€‰
    document.getElementById('reset-filters').addEventListener('click', () => {
        document.getElementById('filter-author').value = '';
        document.getElementById('filter-library').value = '';
        document.querySelectorAll('.format-checkbox').forEach(cb => cb.checked = false);
        currentFilters = { author_id: null, formats: [], library_id: null };
        currentPage = 1;
        updateActiveFilterTags();
        performSearch();
    });
    
    // åˆ‡æ¢ç­›é€‰é¢æ¿
    document.getElementById('toggle-filters').addEventListener('click', () => {
        const panel = document.getElementById('filter-panel');
        const icon = document.getElementById('filter-toggle-icon');
        const text = document.getElementById('filter-toggle-text');
        
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            icon.textContent = 'â–²';
            text.textContent = 'æ”¶èµ·';
        } else {
            panel.classList.add('hidden');
            icon.textContent = 'â–¼';
            text.textContent = 'å±•å¼€';
        }
    });
    
    // æ¸…ç©ºå†å²
    document.getElementById('clear-history').addEventListener('click', () => {
        localStorage.removeItem('searchHistory');
        document.getElementById('search-history').classList.add('hidden');
    });
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
        // Esc æ¸…ç©ºæœç´¢æ¡†
        if (e.key === 'Escape') {
            searchInput.value = '';
            searchInput.focus();
        }
        // / èšç„¦æœç´¢æ¡†
        if (e.key === '/' && !searchInput.contains(document.activeElement)) {
            e.preventDefault();
            searchInput.focus();
        }
    });
}

// åŠ è½½ä½œè€…åˆ—è¡¨
async function loadAuthors() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/api/authors', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            authorsCache = await response.json();
            const select = document.getElementById('filter-author');
            authorsCache.forEach(author => {
                const option = document.createElement('option');
                option.value = author.id;
                option.textContent = `${author.name} (${author.book_count})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½ä½œè€…åˆ—è¡¨å¤±è´¥:', error);
    }
}

// åŠ è½½ä¹¦åº“åˆ—è¡¨
async function loadLibraries() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/api/libraries', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            librariesCache = await response.json();
            const select = document.getElementById('filter-library');
            librariesCache.forEach(library => {
                const option = document.createElement('option');
                option.value = library.id;
                option.textContent = library.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½ä¹¦åº“åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ‰§è¡Œæœç´¢
async function performSearch() {
    // å¦‚æœæ—¢æ²¡æœ‰æœç´¢è¯ä¹Ÿæ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œæ˜¾ç¤ºåˆå§‹æç¤º
    if (!currentQuery && !hasActiveFilters()) {
        document.getElementById('initial-prompt').classList.remove('hidden');
        document.getElementById('result-stats').classList.add('hidden');
        document.getElementById('books-container').innerHTML = '';
        document.getElementById('pagination').classList.add('hidden');
        document.getElementById('empty').classList.add('hidden');
        document.getElementById('loading').classList.add('hidden');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('initial-prompt').classList.add('hidden');
    document.getElementById('empty').classList.add('hidden');
    document.getElementById('books-container').innerHTML = '';
    
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    const params = new URLSearchParams();
    if (currentQuery) params.append('q', currentQuery);
    params.append('page', currentPage);
    params.append('limit', 20);
    if (currentFilters.author_id) params.append('author_id', currentFilters.author_id);
    if (currentFilters.formats.length > 0) params.append('formats', currentFilters.formats.join(','));
    if (currentFilters.library_id) params.append('library_id', currentFilters.library_id);
    
    try {
        const response = await fetch(`/api/search?${params.toString()}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayResults(data);
            
            // ä¿å­˜æœç´¢å†å²
            if (currentQuery) {
                saveSearchHistory(currentQuery);
            }
            
            // æ›´æ–°URL
            updateURLParams();
        } else if (response.status === 401) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
    } finally {
        document.getElementById('loading').classList.add('hidden');
    }
}

// æ˜¾ç¤ºæœç´¢ç»“æœ
function displayResults(data) {
    const container = document.getElementById('books-container');
    const { books, total, page, total_pages } = data;
    
    totalPages = total_pages;
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    if (total > 0) {
        document.getElementById('result-count').textContent = total;
        document.getElementById('result-stats').classList.remove('hidden');
        document.getElementById('empty').classList.add('hidden');
    } else {
        document.getElementById('result-stats').classList.add('hidden');
        document.getElementById('empty').classList.remove('hidden');
    }
    
    // æ˜¾ç¤ºä¹¦ç±
    container.innerHTML = '';
    books.forEach(book => {
        const card = createBookCard(book);
        container.appendChild(card);
    });
    
    // æ˜¾ç¤ºåˆ†é¡µ
    if (total_pages > 1) {
        renderPagination(page, total_pages);
    } else {
        document.getElementById('pagination').classList.add('hidden');
    }
}

// åˆ›å»ºä¹¦ç±å¡ç‰‡
function createBookCard(book) {
    const card = document.createElement('div');
    card.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer';
    card.onclick = () => window.location.href = `/book/${book.id}`;
    
    card.innerHTML = `
        <h3 class="text-lg font-semibold mb-2 line-clamp-2">${escapeHtml(book.title)}</h3>
        <p class="text-gray-600 text-sm mb-2">ğŸ‘¤ ${escapeHtml(book.author_name || 'æœªçŸ¥ä½œè€…')}</p>
        <div class="flex justify-between items-center text-xs text-gray-500">
            <span>ğŸ“„ ${book.file_format.toUpperCase()}</span>
            <span>${formatFileSize(book.file_size)}</span>
        </div>
    `;
    
    return card;
}

// æ¸²æŸ“åˆ†é¡µæ§ä»¶
function renderPagination(current, total) {
    const container = document.getElementById('pagination');
    container.innerHTML = '';
    container.classList.remove('hidden');
    
    // ä¸Šä¸€é¡µæŒ‰é’®
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'â† ä¸Šä¸€é¡µ';
    prevBtn.className = `px-4 py-2 rounded-lg ${current === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'}`;
    prevBtn.disabled = current === 1;
    prevBtn.onclick = () => {
        if (current > 1) {
            currentPage = current - 1;
            performSearch();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };
    container.appendChild(prevBtn);
    
    // é¡µç æŒ‰é’®
    const pageNumbers = generatePageNumbers(current, total);
    pageNumbers.forEach(num => {
        if (num === '...') {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.className = 'px-3 py-2 text-gray-500';
            container.appendChild(ellipsis);
        } else {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = num;
            pageBtn.className = num === current 
                ? 'px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold'
                : 'px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-700 hover:bg-gray-50';
            pageBtn.onclick = () => {
                currentPage = num;
                performSearch();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            container.appendChild(pageBtn);
        }
    });
    
    // ä¸‹ä¸€é¡µæŒ‰é’®
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'ä¸‹ä¸€é¡µ â†’';
    nextBtn.className = `px-4 py-2 rounded-lg ${current === total ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'}`;
    nextBtn.disabled = current === total;
    nextBtn.onclick = () => {
        if (current < total) {
            currentPage = current + 1;
            performSearch();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };
    container.appendChild(nextBtn);
}

// ç”Ÿæˆé¡µç æ•°ç»„
function generatePageNumbers(current, total) {
    const pages = [];
    const maxVisible = 7; // æœ€å¤šæ˜¾ç¤º7ä¸ªé¡µç 
    
    if (total <= maxVisible) {
        // æ€»é¡µæ•°å°‘äºç­‰äºæœ€å¤§å¯è§æ•°ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
        for (let i = 1; i <= total; i++) {
            pages.push(i);
        }
    } else {
        // æ€»é¡µæ•°å¤šäºæœ€å¤§å¯è§æ•°ï¼Œéœ€è¦æ™ºèƒ½çœç•¥
        pages.push(1); // å§‹ç»ˆæ˜¾ç¤ºç¬¬ä¸€é¡µ
        
        if (current <= 4) {
            // å½“å‰é¡µé è¿‘å¼€å§‹
            for (let i = 2; i <= 5; i++) pages.push(i);
            pages.push('...');
            pages.push(total);
        } else if (current >= total - 3) {
            // å½“å‰é¡µé è¿‘ç»“å°¾
            pages.push('...');
            for (let i = total - 4; i <= total; i++) pages.push(i);
        } else {
            // å½“å‰é¡µåœ¨ä¸­é—´
            pages.push('...');
            for (let i = current - 1; i <= current + 1; i++) pages.push(i);
            pages.push('...');
            pages.push(total);
        }
    }
    
    return pages;
}

// æ›´æ–°æ¿€æ´»çš„ç­›é€‰æ ‡ç­¾
function updateActiveFilterTags() {
    const container = document.getElementById('filter-tags');
    const activeFiltersDiv = document.getElementById('active-filters');
    container.innerHTML = '';
    
    let hasFilters = false;
    
    if (currentFilters.author_id) {
        const author = authorsCache.find(a => a.id === currentFilters.author_id);
        if (author) {
            hasFilters = true;
            container.appendChild(createFilterTag(`ä½œè€…: ${author.name}`, () => {
                document.getElementById('filter-author').value = '';
                currentFilters.author_id = null;
                updateActiveFilterTags();
                performSearch();
            }));
        }
    }
    
    if (currentFilters.formats.length > 0) {
        hasFilters = true;
        container.appendChild(createFilterTag(`æ ¼å¼: ${currentFilters.formats.map(f => f.toUpperCase()).join(', ')}`, () => {
            document.querySelectorAll('.format-checkbox').forEach(cb => cb.checked = false);
            currentFilters.formats = [];
            updateActiveFilterTags();
            performSearch();
        }));
    }
    
    if (currentFilters.library_id) {
        const library = librariesCache.find(l => l.id === currentFilters.library_id);
        if (library) {
            hasFilters = true;
            container.appendChild(createFilterTag(`ä¹¦åº“: ${library.name}`, () => {
                document.getElementById('filter-library').value = '';
                currentFilters.library_id = null;
                updateActiveFilterTags();
                performSearch();
            }));
        }
    }
    
    activeFiltersDiv.classList.toggle('hidden', !hasFilters);
}

// åˆ›å»ºç­›é€‰æ ‡ç­¾
function createFilterTag(text, onRemove) {
    const tag = document.createElement('span');
    tag.className = 'inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm';
    tag.innerHTML = `
        ${text}
        <button class="hover:text-blue-900 font-bold">Ã—</button>
    `;
    tag.querySelector('button').onclick = onRemove;
    return tag;
}

// æœç´¢å†å²ç®¡ç†
function saveSearchHistory(keyword) {
    if (!keyword.trim()) return;
    
    let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
    history = [keyword, ...history.filter(k => k !== keyword)].slice(0, 5);
    localStorage.setItem('searchHistory', JSON.stringify(history));
    loadSearchHistory();
}

function loadSearchHistory() {
    const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
    const container = document.getElementById('history-tags');
    const historyDiv = document.getElementById('search-history');
    
    if (history.length === 0) {
        historyDiv.classList.add('hidden');
        return;
    }
    
    historyDiv.classList.remove('hidden');
    container.innerHTML = '';
    
    history.forEach(keyword => {
        const tag = document.createElement('button');
        tag.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200';
        tag.textContent = keyword;
        tag.onclick = () => {
            document.getElementById('search-input').value = keyword;
            currentQuery = keyword;
            currentPage = 1;
            performSearch();
        };
        container.appendChild(tag);
    });
}

// å·¥å…·å‡½æ•°
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
